# 《JavaScript 高级程序设计》第十三章：事件

## 简介

JavaScript 与 HTML 的交互是通过“事件”实现的，它相当于两者的枢纽，建立起联接关系。

“事件”就是用户或浏览器自生执行的某种动作，例如用户点击(onclick)，浏览器的资源加载(onload)等，我们可以使用“事件侦听器(Listener)”来预定事件，以便事件发生时执行相应的代码，这种实现模式在软件工程中就被称之为“观察员模式”

“事件”最早出现与 `IE3`, `NetSapce Navigator 2`中，在 `IE4` 与 `NN4` 时 API 开始趋于相似，但直到 DOM2 级的事件模块才开始将其标准化为 DOM 事件。目前 IE9+版本已经完全实现了 DOM 事件的核心部分。

> 浏览器的事件系统除了 DOM 事件，还有 BOM 事件，但是由于 BOM 一直缺乏标准规范（HTML5 已经开始标准化），所以有时会跟 DOM 的某些事件在区分上并不十分清晰。

## 事件流

“事件流”描述的是事件被触发后在文档中的传播与接收的顺序，其中 IE 浏览器提出了“事件冒泡流”，NetSapce 则提出了“事件捕获流”，它们是相反的概念

### 冒泡事件流

事件冒泡(bubbling)是 IE 提出的事件流。即事件从触发事件的目标元素起沿着 DOM 树层层向上传播至 window 为止，也就是说再此之间的元素都可以接收触发的事件。
示例图：

### 捕获事件流

事件捕获(capturing)是 NetSpace 团队提出的。其思想是事件的触发由最顶层的元素开始接收，然后再沿着 DOM 树层层传播至实际触发的目标元素为止。
示例图：

### DOM 事件流

DOM 事件流就是标准事件流，它有三阶段：“捕获阶段”、“目标阶段”、“冒泡阶段”。

- 捕获阶段：当一个事件被触发后，就会由 window 发出，然后沿着 DOM 树不断的层层向下传递，一直传递到目标元素的父元素为止，这一过程就是“捕获阶段”。在这个捕获的过程中，所有经过的节点都会触发这个事件，捕获阶段的任务就是建立事件传递的路线，以后之后的冒泡阶段顺着这条路线返回至 window。由于捕获阶段不会将事件传递到“目标元素”上，所以理论上按照标准规定，事件捕获阶段不会触发目标阶段的事件处理程序。
- 目标阶段：当事件捕获阶段传递完毕后，下一个要传递的事件接收节点便是实际触发元素的目标节点，因此从目标阶段就是从捕获阶段传递到实际的目标元素的过程，目标阶段会触发目标节点的事件处理程序。如果在这一阶段指定了不冒泡，那就会在这里中止.
- 冒泡阶段：目标阶段完成后，事件便会从目标元素的父元素开始沿着捕获阶段的路线以相反的方向从下向上返回最顶层的 window 对象，这一过程就是冒泡阶段，可以看作是捕获阶段的逆传播，因此在事件传播过程中的 DOM 节点理论上都可以触发两次事件，一次是捕获阶段，另一次是在冒泡阶段。但现实情况却不会发生，原因在与 DOM0 级的事件句柄只支持捕获，而 DOM2 级的事件监听器只能在捕获与冒泡两种阶段二选一。

## 事件处理程序

“事件处理程序” 就是响应某个事件的函数或可执行的 JavaScript 语句，也可以称之为“事件侦听器”、“事件句柄”等。
“事件处理程序” 由两部分组成，一部分是“事件属性名”可以看作是“事件处理程序”的函数名，另一部分便是事件处理函数本身，它是事件响应时具体的执行功能。通常我们约定“事件处理程序”属性名是由前缀“on”加上具体的事件名组成，例如 click 事件的事件处理程序（事件属性名、事件句柄属性名）属性名就是 `onclick`，类似的还有 `onload`、`onmouseover` 等。在 DOM 事件体系中，这些事件属性名通常就是对HTML应标签的事件属性或者 DOM 对象的事件属性。

示意图：

“事件”是浏览器的特定动作，它可以被用户或浏览器自身触发，当一个事件被触发后，它便会去查找对应的事件处理程序属性有没有被赋值，如果有，便会执行该“事件处理程序”。

浏览器中的事件一直都是存在的，只是它们对应的事件句柄默认值为 null，因此就算事件被触发也不会进行任何操作，而我们常说的事件绑定，其实并不是真的为 DOM 元素 或事件目标绑定事件，而是为其事件处理程序属性（事件属性、事件侦听器属性、事件句柄属性）赋值(事件处理函数)的过程。

为“事件”指定处理程序的方式有多种，但主要有三大类：事件属性赋值、标准的事件监听器、IE 专有的事件监听器，而“事件属性赋值”又可以分为两种：“HTML 事件处理程序” 和 “DOM0 级事件处理程序”

### HTML 事件处理程序

通过 HTML 标签的事件属性来指定事件处理程序：

```html
<div onclick="javascript:alert('hello world!')"></div>
```

> 通过标签的事件属性指定事件处理程序的优点在于事件处理函数中的 `this` 就是当前标签的 DOM 对象本身，而缺点则是很明显 JavaScript 于 HTML 的耦合性太高，不利于后期维护。

### DOM0 级事件处理程序

### DOM2 级事件处理程序

优点：
支持 DOM 事件流，可以指定是捕获还是冒泡。
支持指定多个事件处理程序并存。
事件处理程序中的 this 指向的就是 DOM 对象自身。

缺点：
移除时，必须与指定时的参数完全相同。

### IE 专有事件处理程序

优点：
支持指定多个事件处理程序并存。

缺点：
事件处理程序中 this 默认指向的时 window 而非事件处理程序附加的 DOM 对象本身。
移除时，必须与指定时的参数完全相同。
不支持 DOM 事件流，只支持事件冒泡。
